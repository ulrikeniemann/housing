---
title: "dev-save_data"
output: rmarkdown::html_vignette
author: "Bruno Rodrigues"
date: "`r Sys.Date()`"
vignette: >
  %\VignetteIndexEntry{dev-save_data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(housing)
```

<!-- WARNING - This vignette is generated by {fusen} from dev/save_data.Rmd: do not edit by hand -->

<!--
Chunks with the keyword 'development' are only used when developing.
Since we need the `{testthat}` library for writing unit tests,
we load it in this development chunk. We will learn more about
unit tests in the next chapter.
-->


```{r warning = FALSE, message = FALSE}
library(dplyr)
library(ggplot2)
library(janitor)
library(purrr)
library(readxl)
library(rvest)
library(stringr)
library(housing)
```

## Downloading the data

This data is downloaded from the luxembourguish [Open Data
Portal](https://data.public.lu/fr/datasets/prix-annonces-des-logements-par-commune/)
(the data set called *SÃ©rie rÃ©trospective des prix annoncÃ©s des maisons par commune, de 2010 Ã  2021*), and the original data is from the "Observatoire de l'habitat". This data
contains prices for houses sold since 2010 for each luxembourguish commune.

The function below uses the permanent URL from the Open Data Portal to access the data,
but I have also rehosted the data, and use my link to download the data (for archival
purposes):


```{r}
raw_data <- get_raw_data(url = "https://github.com/b-rodrigues/rap4all/raw/master/datasets/vente-maison-2010-2021.xlsx")
```

We need clean the data: "Luxembourg" is "Luxembourg-ville" in 2010 and 2011,
then "Luxembourg". "PÃ©tange" is also spelled non-consistently, and we also need
to convert columns to right type. We also directly remove rows where the
locality contains information on the "Source":


```{r}
flat_data <- clean_raw_data(raw_data)
```

We now need to make sure that we got all the communes/localities in there. There
were mergers in 2011, 2015 and 2018. So we need to account for these localities.

Weâ€™re now scraping data from wikipedia of former Luxembourguish communes:


```{r}
former_communes <- get_former_communes()
```

We can scrape current communes:


```{r}
current_communes <- get_current_communes()
```

Letâ€™s now create a list of all communes:


```{r}
former_communes <- get_former_communes()
current_communes <- get_current_communes()

communes <- get_test_communes(former_communes, current_communes)
```

Letâ€™s test to see if all the communes from our dataset are represented.


If the above code doesnâ€™t show any communes, then this means that we are
accounting for every commune.

Letâ€™s keep the national average in another dataset:


```{r}
country_level_data <- make_country_level_data(flat_data)
```

We can finish cleaning the commune data:


```{r}
commune_level_data <- make_commune_level_data(flat_data)
```

We now save the dataset in a folder for further analysis (keep chunk option to
`eval = F` to avoid running it when knitting):



## Functions used for analysis

The following function compute the Laspeyeres prices index:


```{r eval = F}
test_that("get_laspeyeres() produces correct results", {

  input_df <- expand.grid(
    list("year" = c(2010, 2011),
         "locality" = c("Bascharage", "Luxembourg"))
  )

  input_df$n_offers <- c(123, 101, 1230, 1010)
  input_df$average_price_nominal_euros <- c(234, 345, 560, 670)
  input_df$average_price_m2_nominal_euros <- c(23, 34, 56, 67)

  expected_df <- input_df

  # p0 should be always equal to the value in the first year
  expected_df$p0 <- c(234, 234, 560, 560)
  expected_df$p0_m2 <- c(23, 23, 56, 56)

  # pl should be equal to the price divided by p0
  expected_df$pl <- expected_df$average_price_nominal_euros / expected_df$p0 * 100
  expected_df$pl_m2 <- expected_df$average_price_m2_nominal_euros / expected_df$p0_m2 * 100

  expect_equivalent(
    expected_df, get_laspeyeres(input_df)
  )

})
```

```{r examples-get_laspeyeres, eval = FALSE}
#' \dontrun{
#' commune_level_data_laspeyeres <- get_laspeyeres(commune_level_data)
#' } 
```

and this function plots the data:


```{r examples-make_plot, eval = FALSE}
#' \dontrun{
#'commune_level_data_laspeyeres <- get_laspeyeres(commune_level_data)
#'make_plot(commune_level_data_laspeyeres, "Luxembourg")
#' }
```

